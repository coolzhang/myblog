# 目录  
* [CloudQuery使用体验](#cloudquery)  
* [SQLDEV使用体验](#sqldev)
* [Yearning使用体验](#yearning)
* [结论](#conclusion)

# <a name="cloudquery"></a>CloudQuery
![CloudQuery logo](https://cloudquery.club/_next/image?url=%2Fstatic%2Fimages%2Flogo-text.png&w=640&q=75)  
[**CloudQuery**](https://cloudquery.club/)  
**一体化数据管控云平台**  
集成开发者和 DBA 日常所需各种数据工具，提供一体化权限、数据审计等多种安全措施，最大化减小数据风险。  

## 测试版本
v1.3.8.2021052899

## 优点
1. 支持丰富的数据源，如：MySQL、PostgreSQL、Oracle、SQL Server、Redis、MongoDB；  
2. 简单易用的权限管理；   
3. 组织架构设计可以更加清楚用户所在部门；   
4. 页面简洁，左侧树形管理方便操作。  

## 不足
1. 以连接为主体的权限设计，会带来大量重复性的用户授权操作，如：线上、线下环境就需要配置至少2遍授权；另外目前角色字段全局唯一显然是不合理的；  
2. SQL语句并没有做任何安全防范，缺少SQL审计功能，比如：查询返回记录数控制、DML语句执行效率审核、DDL执行时间无法管控；  
3. 组织架构目前没有最大化发挥它的作用，仅仅是个备注而已，可以引入工单流，对于必要变更进行审批；
4. 目前SQL执行数量有限制，主要来自websocket对于消息大小的限制；  
5. 对部署机器配置要求比较高，比较耗内存、费磁盘(输出很多docker日志，据说新版本已解决)；  
6. 测试过程中发现服务不是很稳定，偶尔会出现服务异常的提示。  

## 最佳实践
页面 | 配置 | 备注
--- | ---  | ----
连接管理 |【权限管理】- 分别为每个库的配置操作权限 <br>权限命名：priv_库名、privadm_库名 <br>对应权限：create\select\insert\update\delete、alter/drop  <br>【角色管理】- 角色是权限的集合 <br>角色命名：roleN_连接名简称_环境、roleadm_连接名简称_环境（由于目前设计不合理导致命名费力）| 一般用户只能执行DML操作，只有业务负责人才可以进行DDL操作  
数据查询 | 分组管理连接，可以按照：<br>环境分组(prod、staging、test)或<br>业务分组 |   

# <a name="sqldev"></a>SQLDEV
![SQLDEV logo](https://www.shuaninfo.com/images/%E6%A0%91%E5%AE%89logo.png)  
[**SQLDEV**](http://sqldev.info/)  
是一款数据访问、数据脱敏、权限管控、操作审计为一体的数据库运维工具  

##  测试版本
v 2.0.16  

## 优点
1. 功能丰富；  
2. 支持工单审批和SQL审核；  
3. 权限控制粒度很细(表、字段)。  

## 不足
1. 管理页面配置相对复杂；  
2. 社区版有实例数和登陆用户数限制;  
3. 权限功能设计上有点复杂，数据源中可以配置权限(读/写/管)，项目-用户管理中可以配置管理权限(只有管理权限才可以审批工单)，项目-权限管理中可以配置库表权限(读/写/管/禁)；  
4. 需手动为每个用户配置对应的角色。  

## 最佳实践
页面 | 配置 | 备注
--- | ---  | ----
数据源 | 线上实例权限均设置为：只读 <br>线下实例(test/staging)设置为：读写 | 
用户 | 系统角色均设置为：普通用户  |  
项目列表 | 项目可以按照业务来划分，每个项目可以绑定多个数据源和多个用户 |  
项目 - 权限 | 角色按照用户来划分权限，配置线上线下数据源对应库表的权限 | 管>写>读（上级权限包括下级权限）<br>写 = DML、管 = DDL、禁 = 不可见 | 
项目 - 流程 | 为每个项目创建对应的工单审批项目，然后绑定审批用户，最后将该项目配置到【变更流程】里面 | ![sqldev1](https://github.com/coolzhang/myblog/blob/master/misc/sqldev1.png) <br> ![sqldev2](https://github.com/coolzhang/myblog/blob/master/misc/sqldev2.png)  

# <a name="yearning"></a>Yearning
![Yearning logo](https://github.com/coolzhang/Yearning/raw/master/img/logo.jpg)  
[**Yearning**](https://yearning.io/)  
面向中小型企业的轻量级MySQL SQL语句审核平台，提供查询审计，SQL审核，SQL回滚，自定义工作流等多种功能。  

## 测试版本
v. 2.3.2  

## 优点
1. 简单易用；  
2. 支持SQL审核，可以自定义审核规则；  
3. 支持自定义工单流程；  
4. 支持多种方式创建用户（管理员创建、用户注册、接入LDAP）；  
5. 查询审核开启后，只有管理员同意才可查询，当关闭时用户可自主查询，在审核-查询页面中管理员可以集中管理当前有哪些用户正在访问数据库，随时可以结束查询，用户自己也可以结束本次查询申请；   
6. 工单可以定制DDL/DML语句执行时间。  

## 不足
1. 权限粒度目前只支持到实例级别赋权；   
2. ldap接入后，姓名、部门、邮箱均需要手动修改；  
3. 只支持单一数据库产品：MySQL。  

## 最佳实践
页面 | 配置 | 备注
--- | ---  | ----
管理 - 设置 | 【自定义环境】定义数据源所属环境，添加的环境会出现在【流程模板】中 <br>【排查数据库】一般可以选择过滤掉系统库：mysql、information_schema、performance_schema、sys |  
管理 - 用户 | 接入ldap后，用户需要登录一次系统，用户页面中才能看到申请的用户，然后点击【权限】关联权限组 <br>【角色】默认登陆后的用户为：提交人，部门领导通常作为工单审核人员角色应配置为：操作人 | 
管理 - 数据库 | 新建数据源时选择对应【环境】，未来数据源上面的审核流程将由对应环境决定，【数据源类型】选择：读写 | 
管理 - 权限组 | 【权限组名称】可以根据所在部门命名，然后选择该部门能够访问的数据源 | 
管理 - 流程模板 | 配置不同环境下审批流程，一般流程可以简单定义为：提交阶段 - 审核阶段 - 执行阶段，可以对新增阶段配置审批人员 | 

# <a name="conclusion"></a>结论
最终选择CloudQuery作为SQL查询平台，选择Yearning作为SQL审核平台。  

产品 | 使用范围 | 备注
--- | --- | ---
CloudQuery | 线下环境 Select/DDL/DML  | 无需任何审核，可直接对DB进行操作
Yearning | 线上环境 Select/DDL/DML | 必须由业务负责人审批，DBA通过后才可执行

